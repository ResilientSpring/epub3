##################
ABBYY XML to EPUB3
##################

************
Introduction
************

This module transforms ABBYY XML documents, generated by ABBYY FineReader 10,
into primitively accessible ePub 3. The code is optimized for ABBYY XML
documents created by the Internet Archive, though it may work for other ABBYY
XML as well.

Features
========

#. Unicode-compliant
#. Can handle left-to-right and right-to-left text.
#. Attempts to recognize running headers, footers, and decimal or page numbers.
   Level of confidence in fuzzy matching can be fine tuned in ``config.ini``.
   Errs on the side of minimizing false positives.
#. Will use Kakadu image libraries if present, otherwise will fall back to Pillow.

Limitations
===========

#. Accessibility is inherently limited by the input ABBYY FineReader documents. If
   they are marked up with headings and other semantic markup, that structure
   will be incorporated into the ePub.
#. There is currently no functionality for image description.
#. The module can also transform ABBYY XML documents generated by ABBYY
   FineReader 6. However, those documents are not marked up with headings, so
   there is no structural navigation for accessibility.

Requirements
============

* Python 3
* If running epubcheck, a Java Runtime environment
* If running DAISY Ace, Node.js
* If using Kakadu, `install the binaries <http://kakadusoftware.com/downloads/>`_ and add the your  PATH and LD_LIBRARY_PATH

Usage
=====

From within a Python program:

.. code:: python

    from abbyy_to_epub3 import create_epub
    book = create_epub.Ebook('docname')  # See *Assumptions* below.
    book.craft_epub()

From the shell:

.. code:: bash

     abbyy2epub docname     # See *Assumptions* below.

The available command line arguments are:

.. code:: bash 

    usage: abbyy2epub [-h] [-d] [--epubcheck] [--ace] docname

    Process an ABBYY file into an EPUB

    positional arguments:
      item_dir         The file path where this item's files are kept.
      item_identifier  The unique ID of this item.
      item_bookpath    The prefix to a specific book within an item.In a simple
                       book, usually the same as the item_identifier.

    optional arguments:
      -h, --help   show this help message and exit
      -d, --debug  Show debugging information
      --epubcheck  Run EpubCheck on the newly created EPUB
      --ace        Run DAISY Ace on the newly created EPUB


System dependencies
===================

If you'd like to run `epubcheck <https://github.com/IDPF/epubcheck>`_, there
are certain system dependencies.  Depending on running environment, these may
need to be manually installed.  On Ubuntu, I installed these with:

.. code:: bash

    sudo apt-get install default-jre libpython3-dev

If you'd like to run the DAISY Ace accessibility checker, you'll also need
Node.js and Ace. On Ubuntu, I installed these with:

.. code:: bash

    sudo apt-get install nodejs
    sudo npm install ace-core -g

If Ace successfully installed, you should be able to run:

.. code:: bash

   ace --help

at the command line. This should display usage information. For more
information see the `Ace Getting Started Guide
<http://inclusivepublishing.org/toolbox/accessibility-checker/getting-started/>`.

Installation
============

This package can be installed on your local system. From the directory
containing setup.py:

.. code:: bash

    pip install -r requirements.txt
    python setup.py develop
    pip install .

You can rebuild the documentation, which is generated with Sphinx.

.. code:: bash

   cd docs
   make html

Deploying
===================

Before deploying, make sure you bump the version of the package in `__init__.py`. Then, run the `upload.sh` script in the root of the repository and enter the appropriate Internet Archive credentials when prompted.

You can test that the package has been installed correctly by going to https://devpi.archive.org or by running `$ pip3 install --upgrade -i https://petaboxdevpi:{PASSWORD}@devpi.archive.org/books/formats abbyy_to_epub3`.

Note that `petaboxdevpi:{PASSWORD}` is not needed inside IA network`

Testing
===================

Run ``py.test`` from the top-level app directory. Create new tests in the ``tests``
subdirectory.

Assumptions
===================

An item may contain 1 or more books. In order to accommodate this subtlety and
delineate between books, an `item_dir` and `item_identifier` are not sufficient
to isolate a specific book. To circumvent this limitation, we require another
identifier called the `item_bookpath` which acts as a prefix to the files of a
specific book. Given a datanode and an `item_dir` of an item, all the
constituent files for a book can be constructed using `item_identifier` and
`item_bookpath` in the following ways:

- The `item_identifier` (the unique ID of this item)
- The `item_dir` is the file path where this items files are kept
- The `item_bookpath` is name of the particular book file, often the same as `item_identifier`

The structure is assumed to be:

- ``scandata.xml`` describes the structure of the book (metadata, pages numbers)
* ``docname_abbyy.gz`` unzips to ``docname_abbyy``, an XML file generated by
  ABBYY.
* ``docname_jp2.zip`` unzips to a directory called ``docname_jp2``, which
  includes a number of documents in the format ``docname_####.jp2``.

  * ``docname_0000.jp2`` is scanner calibration.
  * ``docname_0001.jp2`` is the cover image and the first image reference in the
    ABBYY.
* There is a single global metadata manifest file for the entire
  item named ``{item_identifier}_meta.xml``.
* All of the other book specific files follow the form
  ``{item_bookpath}_{file}``. e.g. ``{item_bookpath}_abbyy.gz``

Further Reading
===============

Module documentation is available at
`Read The Docs <http://abbyy-to-epub3.readthedocs.io/en/latest/>`_.

Contribute
==========

* `Source code on GitHub <https://github.com/deborahgu/abbyy-to-epub3/issues>`_
* `Issue tracker <https://github.com/deborahgu/abbyy-to-epub3/issues>`_
